<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mealkitz - Punto de Venta</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8f9fa;
        padding-top: 1rem;
      }
      .navbar {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        background-color: #fff;
        margin-bottom: 1rem;
      }
      .navbar-brand {
        font-weight: 600;
        color: #123a62 !important;
      }
      .navbar-toggler {
        border: none;
      }
      .navbar-toggler-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(18,58,98,0.8)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      }

      .btn {
        font-weight: normal;
        border-radius: 0.375rem;
        transition: all 0.2s ease-in-out;
      }
      .btn-primary {
        background-color: #123a62;
        color: #fff;
        border-color: #123a62;
      }
      .btn-primary:hover {
        background-color: #0e3150;
        border-color: #0e2d4e;
        transform: translateY(-1px);
      }
      .btn-secondary {
        background-color: #6c757d;
        color: #fff;
        border-color: #6c757d;
      }
      .btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-1px);
      }
      .hero-blue-background {
        background-color: #123a62;
        color: #fff;
        padding: 2rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
      }
      .hero-blue-background h1 {
        margin: 0;
        font-weight: normal;
      }
      .hero-blue-background .lead {
        color: #f1f1f1;
        font-size: 1rem;
      }
      main.container.custom-main {
        background: #fff;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin: 2rem auto;
        max-width: 800px;
      }
      @media (max-width: 767.98px) {
        .btn-lg.full-width-sm {
          display: block;
          width: 100%;
        }
      }

      #navbarIcons.collapsing {
        height: 0;
        overflow: hidden;
        transition: height 0.5s ease-in-out;
      }

      /* Action Card Styles */
      .action-card-grid {
        margin-top: 1.5rem;
      }
      .action-card {
        display: block;
        background-color: #ffffff;
        border-radius: 0.75rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        padding: 1.5rem;
        text-align: center;
        text-decoration: none;
        color: inherit;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .action-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        color: inherit;
      }
      .action-card-icon {
        font-size: 2.5rem;
        color: #123a62;
        margin-bottom: 0.75rem;
      }
      .action-card-title {
        font-size: 1rem;
        font-weight: 600;
        color: #343a40;
      }

      /* Custom Navbar Link Styling */
      @media (max-width: 767.98px) { /* Bootstrap's md breakpoint */
        .navbar-collapse .navbar-nav .nav-item {
          text-align: center;
        }
        .navbar-collapse .navbar-nav .nav-link {
          padding-top: 0.75rem;
          padding-bottom: 0.75rem;
          /* border-bottom: 1px solid #eee; */ /* Optional separator */
        }
        /* .navbar-collapse .navbar-nav .nav-item:last-child .nav-link {
          border-bottom: none;
        } */
        .navbar-collapse .navbar-nav {
          margin-top: 0.5rem;
        }
        .navbar-collapse .navbar-nav.me-auto {
            margin-right: 0 !important; /* Override me-auto for centering */
            margin-left: 0 !important;
            width: 100%;
        }
         .navbar-collapse .d-flex.ms-auto {
            width: 100%;
            justify-content: center;
            margin-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
      }

      /* Desktop Navbar Link Centering */
      @media (min-width: 768px) {
        .navbar-collapse {
          /* justify-content: space-between; */ /* This might be too much if brand is not also flex item */
        }
        /* Attempt to center the me-auto block */
        .navbar-collapse ul.navbar-nav.me-auto {
            position: absolute; /* Take out of flow */
            left: 50%;
            transform: translateX(-50%); /* Center it */
            /* Ensure it doesn't overlap with other elements like brand or right-side icons */
            /* This might need adjustments based on the exact width of your brand and right-side icons */
        }
      }

      .navbar-nav .nav-link {
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
      }
      .navbar-nav .nav-link:hover,
      .navbar-nav .nav-link:focus {
        background-color: #e9ecef; /* Light hover/focus background */
        color: #0056b3; /* Darker blue for text on hover/focus */
        border-radius: 0.375rem; /* Rounded corners on hover */
      }
      .navbar-nav .nav-link i {
        font-size: 1.1em;
        vertical-align: text-bottom; /* Align icon better with text */
        margin-right: 0.35em !important; /* Ensure spacing from text */
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-white navbar-expand-md py-2">
      <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img
            src="Images/mk_logo.jpeg"
            style="height: 35px; margin-right: 5px;"
            alt="Mealkitz Logo"
          />
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarIcons"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
    
        <div class="collapse navbar-collapse" id="navbarIcons">
          <!-- IZQUIERDA: enlaces a cada acción -->
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <!-- Ingresar tus Datos -->
            <li class="nav-item">
              <a class="nav-link" href="config.html">
                <i class="bi bi-person-badge-fill me-1"></i>
                Ingresar tus Datos
              </a>
            </li>
    
            <!-- Cobro Manual (abre modal) -->
            <li class="nav-item">
              <a
                class="nav-link"
                href="#"
                data-bs-toggle="modal"
                data-bs-target="#manualChargeModal"
              >
                <i class="bi bi-cash-coin me-1"></i>
                Cobro Manual
              </a>
            </li>
    
            <!-- Generar Cotización (abre modal) -->
            <li class="nav-item">
              <a
                class="nav-link"
                href="#"
                data-bs-toggle="modal"
                data-bs-target="#cotizacionModal"
              >
                <i class="bi bi-file-earmark-text-fill me-1"></i>
                Generar Cotización
              </a>
            </li>
    
            <!-- Cobro con QR (abre modal "Próximamente") -->
            <li class="nav-item">
              <a
                class="nav-link"
                href="#"
                data-bs-toggle="modal"
                data-bs-target="#proximamenteQRModal"
              >
                <i class="bi bi-qr-code me-1"></i>
                Cobro con QR
              </a>
            </li>
    
            <!-- Tu Tienda En Línea -->
            <li class="nav-item">
              <a class="nav-link" href="e-commerce.html">
                <i class="bi bi-shop me-1"></i>
                Tu Tienda En Línea
              </a>
            </li>
    
            <!-- Pedidos -->
            <li class="nav-item">
              <a class="nav-link" href="pedidos.html">
                <i class="bi bi-box-seam me-1"></i>
                Pedidos
              </a>
            </li>
    
            <!-- Ayuda -->
            <li class="nav-item">
              <a class="nav-link" href="ayuda.html">
                <i class="bi bi-question-circle-fill me-1"></i>
                Ayuda
              </a>
            </li>
          </ul>
    
          <!-- DERECHA: notificaciones, compartir, perfil y buscador -->
          <div class="d-flex align-items-center ms-auto">
            <button class="btn btn-link text-dark me-3" title="Notificaciones">
              <i class="bi bi-bell-fill fs-4"></i>
            </button>
            <a
              href="#"
              id="whatsapp-share-btn"
              class="btn btn-link text-dark me-3"
              title="Compartir en WhatsApp"
            >
              <i class="bi bi-whatsapp fs-4"></i>
            </a>
            <div class="nav-item dropdown">
              <a
                href="#"
                class="btn btn-link text-dark me-3 dropdown-toggle d-flex align-items-center"
                id="profileDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                title="Perfil"
              >
                <img
                  id="profileImageLogo"
                  src=""
                  alt="Profile Logo"
                  style="height: 28px; width: 28px; border-radius: 50%; margin-right: 8px; display: none;"
                />
                <i class="bi bi-person-circle fs-4 me-2" id="defaultProfileIcon"></i>
                <span id="profileDropdownName">Perfil</span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="profileDropdown"
                id="profileDropdownMenu"
              >
                <li>
                  <a class="dropdown-item" href="perfil.html" id="viewProfileLink"
                    >Crear Perfil</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="iniciar.html"
                    id="loginOrLogoutLink"
                    >Iniciar Sesión</a
                  >
                </li>
              </ul>
        </div>
      </div>
    </nav>

    <main class="container custom-main">
      <section class="hero-blue-background text-left">
        <h1>Mealkitz.io (DEMO)</h1>
        <p class="lead">
          Esta es una herramienta para configurar productos, iniciar cobros y
          gestionar tu tienda en línea.
        </p>
      </section>

      <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4 action-card-grid">
        <!-- Ingresar tus Datos -->
        <div class="col">
          <a href="config.html" class="action-card">
            <div class="action-card-icon"><i class="bi bi-person-badge-fill"></i></div>
            <div class="action-card-title">Ingresar tus Datos</div>
          </a>
        </div>

        <!-- Cobro Manual -->
        <div class="col">
          <a href="#" class="action-card" data-bs-toggle="modal" data-bs-target="#manualChargeModal">
            <div class="action-card-icon"><i class="bi bi-cash-coin"></i></div>
            <div class="action-card-title">Cobro Manual</div>
          </a>
        </div>

        <!-- Generar Cotización -->
        <div class="col">
          <a href="#" class="action-card" data-bs-toggle="modal" data-bs-target="#cotizacionModal">
            <div class="action-card-icon"><i class="bi bi-file-earmark-text-fill"></i></div>
            <div class="action-card-title">Generar Cotización</div>
          </a>
        </div>

        <!-- Cobro con QR -->
        <div class="col">
          <a href="#" class="action-card" data-bs-toggle="modal" data-bs-target="#proximamenteQRModal">
            <div class="action-card-icon"><i class="bi bi-qr-code"></i></div>
            <div class="action-card-title">Cobro con QR</div>
          </a>
        </div>

        <!-- Tu Tienda En Línea -->
        <div class="col">
          <a href="e-commerce.html" class="action-card">
            <div class="action-card-icon"><i class="bi bi-shop"></i></div>
            <div class="action-card-title">Tu Tienda En Línea</div>
          </a>
        </div>

        <!-- Pedidos -->
        <div class="col">
          <a href="pedidos.html" class="action-card">
            <div class="action-card-icon"><i class="bi bi-box-seam"></i></div>
            <div class="action-card-title">datos.html</div>
          </a>
        </div>

    </main>

    <!-- Modal Único: Cobro Manual (con checkbox para encuesta) -->
    <div
      class="modal fade"
      id="manualChargeModal"
      tabindex="-1"
      aria-labelledby="manualChargeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="manualChargeModalLabel">
              Cobro Manual
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="manualChargeForm">
              <!-- 1) Selección de Producto -->
              <div class="mb-3">
                <label for="mcProduct" class="form-label"
                  >Selecciona un producto</label
                >
                <select
                  id="mcProduct"
                  class="form-select"
                  required
                  aria-describedby="mcProductHelp"
                >
                  <option value="" selected disabled>
                    Elige un producto...
                  </option>
                </select>
                <div id="mcProductHelp" class="form-text">
                  Elige de tu catálogo el producto que deseas cobrar.
                </div>
              </div>

              <!-- 2) Revisión de datos (negocio, fecha y precio) -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="mcBusiness" class="form-label">Negocio</label>
                  <input
                    type="text"
                    id="mcBusiness"
                    class="form-control"
                    readonly
                    placeholder="Negocio"
                  />
                </div>
                <div class="col-md-4">
                  <label for="mcDatetime" class="form-label">Fecha / Hora</label>
                  <input
                    type="text"
                    id="mcDatetime"
                    class="form-control"
                    readonly
                    placeholder="Fecha y Hora"
                  />
                </div>
                <div class="col-md-4">
                  <label for="mcPrice" class="form-label">Precio</label>
                  <input
                    type="number"
                    step="0.01"
                    id="mcPrice"
                    class="form-control"
                    readonly
                    placeholder="Precio"
                  />
                </div>
              </div>

              <!-- 3) Método de pago -->
              <div class="mb-3">
                <label class="form-label">Método de pago</label>
                <div
                  id="mcPaymentMethodsContainer"
                  class="d-flex gap-2 flex-wrap"
                >
                  <!-- Botones de métodos se insertarán por JavaScript -->
                </div>
                <div id="mcPaymentHelp" class="form-text">
                  Selecciona cómo deseas que el cliente pague.
                </div>
              </div>

              <!-- 4) WhatsApp del cliente (opcional) -->
              <div class="mb-3">
                <label for="mcWhatsapp" class="form-label"
                  >Número de WhatsApp (opcional)</label
                >
                <input
                  type="tel"
                  id="mcWhatsapp"
                  class="form-control"
                  placeholder="Ej: +507 6123-4567"
                />
                <div id="mcWhatsappHelp" class="form-text">
                  Si desea enviar confirmación automática por WhatsApp.
                </div>
              </div>

              <!-- 5) Checkbox: Enviar encuesta -->
              <div class="form-check mb-3">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="mcSurvey"
                />
                <label class="form-check-label" for="mcSurvey">
                  Deseo recibir encuesta después de mi compra
                </label>
              </div>

              <!-- 6) Botón Finalizar Cobro -->
              <div class="text-end mt-4">
                <button
                  type="submit"
                  id="mcSubmit"
                  class="btn btn-success"
                  disabled
                >
                  Procesar y Enviar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Cotización Modal -->
    <div
      class="modal fade"
      id="cotizacionModal"
      tabindex="-1"
      aria-labelledby="cotizacionModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cotizacionModalLabel">
              Generador de Cotización
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="cotizacionForm">
              <div class="mb-3">
                <label for="cotizacionClienteNombre" class="form-label"
                  >Nombre del Cliente</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="cotizacionClienteNombre"
                  required
                />
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cotizacionClienteEmail" class="form-label"
                    >Correo Electrónico del Cliente</label
                  >
                  <input
                    type="email"
                    class="form-control"
                    id="cotizacionClienteEmail"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="cotizacionClienteTelefono" class="form-label"
                    >Teléfono del Cliente (Opcional)</label
                  >
                  <input
                    type="tel"
                    class="form-control"
                    id="cotizacionClienteTelefono"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="cotizacionDescripcion" class="form-label"
                  >Descripción de Servicios/Productos</label
                >
                <textarea
                  class="form-control"
                  id="cotizacionDescripcion"
                  rows="4"
                  placeholder="Detallar los ítems de la cotización, uno por línea si es posible. Ej:
Diseño de Logo - $XXX
Desarrollo Web Básico - $YYY"
                  required
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cotizacionMontoTotal" class="form-label"
                    >Monto Total de la Cotización</label
                  >
                  <div class="input-group">
                    <span class="input-group-text" id="cotizacionCurrencySymbol"
                      >$</span
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="cotizacionMontoTotal"
                      step="0.01"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="cotizacionNotas" class="form-label"
                  >Notas Adicionales (Opcional)</label
                >
                <textarea
                  class="form-control"
                  id="cotizacionNotas"
                  rows="2"
                  placeholder="Ej: Validez de la cotización: 30 días. Condiciones de pago."
                ></textarea>
              </div>
              <div class="form-text mb-3">
                Esta cotización utilizará los datos de tu negocio configurados (si
                aplica para la presentación).
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cerrar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="generarCotizacionBtn"
            >
              Generar y Enviar Cotización
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- End Cotización Modal -->

    <!-- Modal Próximamente QR -->
    <div
      class="modal fade"
      id="proximamenteQRModal"
      tabindex="-1"
      aria-labelledby="proximamenteQRModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="proximamenteQRModalLabel">
              Funcionalidad Avanzada
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Cobros con QR, Reportes avanzados e acceso a inversiones son
              funciones avanzadas que se desbloquearán al usar el sistema de forma
              constante.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
              Entendido
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- End Modal Próximamente QR -->

    <!-- Modal de Inicio de Sesión Requerido -->
    <div class="modal fade" id="loginRequiredModal" tabindex="-1" aria-labelledby="loginRequiredModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginRequiredModalLabel"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Inicio de Sesión Requerido</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p>Para acceder a esta función, por favor, inicia sesión o crea una cuenta.</p>
          </div>
          <div class="modal-footer justify-content-center">
            <a href="iniciar.html" class="btn btn-primary">Iniciar Sesión</a>
            <a href="iniciar.html?action=register" class="btn btn-success">Crear Cuenta</a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/navbar-loader.js" defer></script>
    <script src="js/auth-navbar.js" defer></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- BEGIN NEW FEATURE GATING AND LOGIN CHECK --- 
        const loginRequiredModalEl = document.getElementById('loginRequiredModal');
        const loginRequiredModalInstance = loginRequiredModalEl ? new bootstrap.Modal(loginRequiredModalEl) : null;
        let postLoginRedirectData = null;

        try {
            const postLoginRedirectRAW = sessionStorage.getItem('postLoginRedirect');
            if (postLoginRedirectRAW) {
                postLoginRedirectData = JSON.parse(postLoginRedirectRAW);
            }
        } catch (e) {
            console.error("Error parsing postLoginRedirect from sessionStorage:", e);
            sessionStorage.removeItem('postLoginRedirect');
        }

        const currentUser = localStorage.getItem('currentUser_mealkitz');

        // If not logged in AND no postLoginRedirect is active for this page, redirect to login.
        // This protects direct access to punto.html if not logged in.
        if (!currentUser && (!postLoginRedirectData || postLoginRedirectData.page !== 'punto.html')) {
            window.location.href = 'iniciar.html?redirect=punto.html'; // Add redirect param for context
            return; // Stop further script execution on this page
        }

        const commonLoginCheck = (event, destination) => {
            if (!currentUser) { // currentUser is already fetched at the top of DOMContentLoaded
                if (event) event.preventDefault();
                if (loginRequiredModalInstance) {
                    sessionStorage.setItem('postLoginRedirect', JSON.stringify(destination));
                    loginRequiredModalInstance.show();
                } else {
                    console.error('Login Required Modal not found or initialized on punto.html.');
                    window.location.href = 'iniciar.html';
                }
                return false;
            }
            return true;
        };

        // After login, if redirected back with a hash for a modal on *this* page (punto.html):
        if (postLoginRedirectData && postLoginRedirectData.page === 'punto.html' && postLoginRedirectData.hash) {
            const targetModalId = postLoginRedirectData.hash.substring(1); // remove #
            const modalElement = document.getElementById(targetModalId);
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                if (modalInstance) modalInstance.show();
            }
            sessionStorage.removeItem('postLoginRedirect'); // Clear after processing
        }

        // Gate action cards and navbar links that navigate or open modals
        // Example: Link to config.html
        document.querySelectorAll('a[href="config.html"]').forEach(link => {
            link.addEventListener('click', function(event) {
                commonLoginCheck(event, { page: 'config.html' });
            });
        });
        // Example: Modal trigger for #manualChargeModal
        document.querySelectorAll('[data-bs-target="#manualChargeModal"]').forEach(trigger => {
            trigger.addEventListener('click', function(event) {
                commonLoginCheck(event, { page: 'punto.html', hash: '#manualChargeModal' });
            });
        });
        // Add more for other modals and links as needed, e.g.:
        // Cotizacion Modal
        document.querySelectorAll('[data-bs-target="#cotizacionModal"]').forEach(trigger => {
            trigger.addEventListener('click', function(event) {
                commonLoginCheck(event, { page: 'punto.html', hash: '#cotizacionModal' });
            });
        });
        // Proximamente QR Modal (though it's informational, good practice)
        document.querySelectorAll('[data-bs-target="#proximamenteQRModal"]').forEach(trigger => {
            trigger.addEventListener('click', function(event) {
                commonLoginCheck(event, { page: 'punto.html', hash: '#proximamenteQRModal' });
            });
        });
        // Tu Tienda En Línea
        document.querySelectorAll('a[href="e-commerce.html"]').forEach(link => {
            link.addEventListener('click', function(event) {
                commonLoginCheck(event, { page: 'e-commerce.html' });
            });
        });
        // Pedidos
        document.querySelectorAll('a[href="pedidos.html"]').forEach(link => {
            link.addEventListener('click', function(event) {
                commonLoginCheck(event, { page: 'pedidos.html' });
            });
        });
         // Ayuda (assuming it doesn't require login, so no check needed. If it does, add it)
         // document.querySelectorAll('a[href="ayuda.html"]').forEach(link => { ... });

        // --- END NEW FEATURE GATING AND LOGIN CHECK ---

        // Cargar configuración (negocio, productos, métodos de pago) desde localStorage
        let mealkitzConfig = {};
        try {
          const storedConfig = localStorage.getItem("mealkitzConfig");
          if (storedConfig) {
            mealkitzConfig = JSON.parse(storedConfig);
          } else {
            mealkitzConfig = {
              business: { name: "Mi Tienda (defecto)", currency: "$" },
              payments: { methods: ["Efectivo"] },
              products: [],
            };
          }
        } catch {
          mealkitzConfig = {
            business: { name: "Mi Tienda (defecto)", currency: "$" },
            payments: { methods: ["Efectivo"] },
            products: [],
          };
        }
        // Si no hay productos configurados, ejemplo por defecto
        if (
          !Array.isArray(mealkitzConfig.products) ||
          mealkitzConfig.products.length === 0
        ) {
          mealkitzConfig.products = [
            { id: 1, name: "Producto A", price: 10.0 },
            { id: 2, name: "Producto B", price: 15.5 },
            { id: 3, name: "Producto C", price: 7.25 },
          ];
        }
        // Variables DOM
        const mcProduct = document.getElementById("mcProduct");
        const mcBusiness = document.getElementById("mcBusiness");
        const mcDatetime = document.getElementById("mcDatetime");
        const mcPrice = document.getElementById("mcPrice");
        const mcPaymentContainer = document.getElementById("mcPaymentMethodsContainer");
        const mcWhatsapp = document.getElementById("mcWhatsapp");
        const mcSurvey = document.getElementById("mcSurvey");
        const mcSubmit = document.getElementById("mcSubmit");

        // Rellenar select de productos
        function populateProductSelect() {
          mcProduct.innerHTML =
            '<option value="" disabled selected>Elige un producto...</option>';
          mealkitzConfig.products.forEach((p, idx) => {
            const opt = document.createElement("option");
            opt.value = idx;
            opt.textContent = `${p.name} - ${
              mealkitzConfig.business.currency
            }${p.price.toFixed(2)}`;
            mcProduct.appendChild(opt);
          });
        }
        // Rellenar métodos de pago
        function populatePaymentMethods() {
          mcPaymentContainer.innerHTML = "";
          let methods = ["Efectivo"];
          if (
            mealkitzConfig.payments &&
            Array.isArray(mealkitzConfig.payments.methods) &&
            mealkitzConfig.payments.methods.length > 0
          ) {
            methods = mealkitzConfig.payments.methods;
          }
          methods.forEach((m) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn btn-outline-primary me-2 mb-2 pay-btn";
            btn.textContent = m.charAt(0).toUpperCase() + m.slice(1);
            btn.dataset.pay = m;
            mcPaymentContainer.appendChild(btn);
          });
        }
        // Estado de orden en memoria
        let currentOrder = {
          product: null,
          paymentMethod: null,
          whatsapp: "",
          survey: false,
        };
        // Cuando cambia producto:
        mcProduct.addEventListener("change", () => {
          const idx = parseInt(mcProduct.value, 10);
          const selected = mealkitzConfig.products[idx];
          if (selected) {
            currentOrder.product = selected;
            mcBusiness.value = mealkitzConfig.business.name;
            mcDatetime.value = new Date().toLocaleString();
            mcPrice.value = selected.price.toFixed(2);
          }
          updateSubmitState();
        });
        // Cuando selecciona método de pago:
        mcPaymentContainer.addEventListener("click", (e) => {
          if (e.target.classList.contains("pay-btn")) {
            // Limpiar clases "activo"
            document
              .querySelectorAll("#mcPaymentMethodsContainer .pay-btn")
              .forEach((b) => {
                b.classList.remove("btn-primary");
                b.classList.add("btn-outline-primary");
              });
            // Marcar este botón como activo
            e.target.classList.remove("btn-outline-primary");
            e.target.classList.add("btn-primary");
            currentOrder.paymentMethod = e.target.dataset.pay;
          }
          updateSubmitState();
        });
        // Cuando cambia WhatsApp:
        mcWhatsapp.addEventListener("input", () => {
          currentOrder.whatsapp = mcWhatsapp.value.trim();
        });
        // Checkbox encuesta:
        mcSurvey.addEventListener("change", () => {
          currentOrder.survey = mcSurvey.checked;
        });
        // Habilitar botón de submit solo si hay producto y método de pago
        function updateSubmitState() {
          if (currentOrder.product && currentOrder.paymentMethod) {
            mcSubmit.removeAttribute("disabled");
          } else {
            mcSubmit.setAttribute("disabled", "true");
          }
        }
        // Manejo del formulario de Cobro Manual
        document
          .getElementById("manualChargeForm")
          .addEventListener("submit", (ev) => {
            ev.preventDefault();
            // Construir mensaje de confirmación
            const p = currentOrder.product;
            const payM = currentOrder.paymentMethod;
            const wsp = currentOrder.whatsapp.replace(/\D/g, "");
            let msg = `¡Hola! Quiero ordenar: ${p.name} por ${
              mealkitzConfig.business.currency
            }${p.price.toFixed(2)}. Método de pago: ${payM}.`;
            if (currentOrder.survey) {
              msg += " Por favor, envíenme la encuesta de satisfacción.";
            }
            const finalMsg = wsp
              ? `${msg} Mi WhatsApp: +${wsp}`
              : msg + " (No proporcionó WhatsApp).";
            // Enviar por WhatsApp a número fijo del negocio:
            const negocioWA = "507XXXXXXXX"; // <-- Ajustar al WA real del negocio
            const urlWA = `https://wa.me/${negocioWA}?text=${encodeURIComponent(
              finalMsg
            )}`;
            window.open(urlWA, "_blank");
            // Reiniciar estado:
            document.getElementById("manualChargeForm").reset();
            currentOrder = {
              product: null,
              paymentMethod: null,
              whatsapp: "",
              survey: false,
            };
            updateSubmitState();
            bootstrap
              .Modal.getInstance(
                document.getElementById("manualChargeModal")
              )
              .hide();
            alert("Pedido procesado (simulación). Revisa WhatsApp para confirmar.");
          });

        // Al abrir el modal, poblamos todo
        document
          .getElementById("manualChargeModal")
          .addEventListener("show.bs.modal", () => {
            populateProductSelect();
            populatePaymentMethods();
            mcBusiness.value = "";
            mcDatetime.value = "";
            mcPrice.value = "";
            mcWhatsapp.value = "";
            mcSurvey.checked = false;
            updateSubmitState();
          });

        // Make sure all other event listeners and functions are properly closed
        // ... (rest of the script, assuming it's correct or to be reviewed if errors persist)
      }); // This is the closing for DOMContentLoaded
    </script>
  </body>
</html>

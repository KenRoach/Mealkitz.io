<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mealkitz - Punto de Venta</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
      body { 
        font-family: 'Poppins', sans-serif; 
        background-color: #f8f9fa;
        padding-top: 1rem;
      }
      .navbar { 
        box-shadow: 0 2px 4px rgba(0,0,0,.08); 
        background-color: #fff; 
        margin-bottom: 1rem;
      }
      .navbar-brand { font-weight: 600; color: #123A62 !important; }
      .navbar-toggler { border: none; }
      .navbar-toggler-icon { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(18,58,98,0.8)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e"); }
      
      .btn {
        font-weight: 600;
        border-radius: 0.375rem;
        transition: all 0.2s ease-in-out;
      }
      .btn-primary { 
        background-color: #123A62; 
        color: #fff; 
        border-color: #123A62;
      }
      .btn-primary:hover { 
        background-color: #0e3150; 
        border-color: #0e2d4e; 
        transform: translateY(-1px);
      }
      .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
      }
      .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: #fff;
      }
      .btn-outline-primary {
        border-color: #123A62;
        color: #123A62;
      }
      .btn-outline-primary:hover {
        background-color: #123A62;
        color: #fff;
      }
      .btn-link {
        color: #123A62;
        text-decoration: none;
      }
      .btn-link:hover {
        color: #0e3150;
      }
      .btn-lg {
        padding: .75rem 1.5rem;
        font-size: 1.1rem;
      }

      main.container.custom-main {
        background: #fff;
        padding: 2rem;
        border-radius: .75rem; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        margin-top: 2rem; 
        margin-bottom: 2rem;
      }
      .lead { 
        color: #495057;
        font-size: 1.1rem;
        font-weight: 300;
        margin-bottom: 1.5rem; 
      }
      
      .modal-body { padding: 1.5rem; } 
      .form-control, .form-select { margin-bottom: 1rem; }

      @media (max-width: 767.98px) { 
        .btn-lg.full-width-sm { 
          display: block;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-white navbar-expand-md py-2">
      <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="Images/mk_logo.jpeg" style="height: 35px; margin-right: 10px;" alt="Mealkitz Logo">
          <span></span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarIcons" aria-controls="navbarIcons" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarIcons">
          <div class="d-flex align-items-center ms-auto">
            <button class="btn btn-link text-dark me-3" title="Notificaciones"><i class="bi bi-bell-fill fs-4"></i></button>
            <a href="#" id="whatsapp-share-btn-punto" class="btn btn-link text-dark me-3" title="Compartir en WhatsApp">
              <i class="bi bi-whatsapp fs-4"></i>
            </a>
            <a href="perfil.html" class="btn btn-link text-dark me-3" title="Ajustes">
              <i class="bi bi-gear-fill fs-4"></i>
            </a>
            <div class="nav-item dropdown">
              <a href="#" class="btn btn-link text-dark me-3 dropdown-toggle" id="profileDropdownPunto" role="button" data-bs-toggle="dropdown" aria-expanded="false" title="Perfil">
                <i class="bi bi-person-circle fs-4"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdownPunto">
                <li><a class="dropdown-item" href="perfil.html">Crear Perfil</a></li>
                <li><a class="dropdown-item" href="#">Iniciar Sesión</a></li>
              </ul>
            </div>
            <a href="ayuda.html" class="btn btn-link text-dark me-3" title="Buscar"><i class="bi bi-search fs-4"></i></a>
          </div>
        </div>
      </div>
    </nav>

    <main class="container custom-main">
        <div class="text-left"> 
          <h2 class="mb-4" style="color:#123A62;">Punto de Venta</h2>
          <p>Configura productos, inicia cobros y gestiona tu tienda online.</p>
        </div>
        <div class="d-flex flex-column flex-md-row flex-wrap justify-content-start gap-3 mt-4">
          <button id="iniciar-cobro-btn" class="btn btn-primary btn-lg full-width-sm">Cobro Manual</button>
          <button id="cobro-qr-btn" class="btn btn-secondary btn-lg full-width-sm">Cobro con QR</button>
          <a href="e-commerce.html" id="tienda-online-btn" class="btn btn-primary btn-lg full-width-sm">Tienda En Línea</a>
        </div>
    </main>

    <!-- Step Modals -->
    <div class="modal fade" id="modal-1" tabindex="-1" aria-labelledby="modal1Label" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="modal1Label">Paso 1: Selecciona un producto</h5></div>
          <div class="modal-body"><select id="product-select" class="form-select"><option value="">Seleccione un producto...</option></select></div>
          <div class="modal-footer d-flex justify-content-end"><button id="next-1" class="btn btn-primary" disabled>Siguiente</button></div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="modal-2" tabindex="-1" aria-labelledby="modal2Label" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="modal2Label">Paso 2: Revisa negocio, fecha y precio</h5></div>
          <div class="modal-body">
            <input type="text" id="business" class="form-control" readonly placeholder="Empresa">
            <input type="text" id="datetime" class="form-control" readonly placeholder="Fecha y Hora">
            <input type="number" id="price" class="form-control" readonly placeholder="Precio">
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <button id="prev-2" class="btn btn-outline-secondary">Atrás</button><button id="next-2" class="btn btn-primary">Siguiente</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="modal-3" tabindex="-1" aria-labelledby="modal3Label" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="modal3Label">Paso 3: Método de pago</h5></div>
          <div class="modal-body">
            <div class="d-grid gap-2">
              <button class="btn btn-outline-primary pay-btn" data-pay="Yappy">Yappy</button>
              <button class="btn btn-outline-primary pay-btn" data-pay="Efectivo">Efectivo</button>
              <button class="btn btn-outline-primary pay-btn" data-pay="Tarjeta">Tarjeta de Crédito/Débito</button>
              <button class="btn btn-outline-primary pay-btn" data-pay="Bitcoin">Bitcoin</button>
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between"><button id="prev-3" class="btn btn-outline-secondary">Atrás</button></div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="modal-4" tabindex="-1" aria-labelledby="modal4Label" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="modal4Label">Paso 4: Confirmar y enviar</h5></div>
          <div class="modal-body">
            <ul class="list-group mb-3" id="summary"></ul>
            <input type="tel" id="whatsapp" class="form-control" placeholder="Número de WhatsApp">
            <button id="photo-btn" class="btn btn-primary w-100 mb-2" style="display:none;">Tomar Foto</button>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <button id="prev-4" class="btn btn-outline-secondary">Atrás</button><button id="send-btn" class="btn btn-success">Procesar y Enviar</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="modal-5" tabindex="-1" aria-labelledby="modal5Label" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header"><h5 class="modal-title" id="modal5Label">Confirmación</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
          <div class="modal-body"><p class="fw-bold">¡Pedido procesado y enviado!</p></div>
          <div class="modal-footer justify-content-center"><button id="restart" class="btn btn-link">Nuevo Pedido</button></div>
        </div>
      </div>
    </div>

    <video id="video" autoplay playsinline style="display:none; position:fixed; bottom:1rem; right:1rem; width:200px; border:2px solid #123A62;"></video>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const modals = {
          1: new bootstrap.Modal(document.getElementById('modal-1')),
          2: new bootstrap.Modal(document.getElementById('modal-2')),
          3: new bootstrap.Modal(document.getElementById('modal-3')),
          4: new bootstrap.Modal(document.getElementById('modal-4')),
          5: new bootstrap.Modal(document.getElementById('modal-5'))
        };
        let order = {};

        const products = [
          {id:'GG001', name:'BBQ Burger', price: 9.50, business:'Garage Grill'},
          {id:'GG002', name:'Alias', price: 5.00, business:'Garage Grill'}, 
          {id:'GG003', name:'Hotdog', price: 6.00, business:'Garage Grill'},
          {id:'GG004', name:'Ribs', price: 18.00, business:'Garage Grill'},
          {id:'GG005', name:'Nachos', price: 7.00, business:'Garage Grill'},
          {id:'GG006', name:'Papas con queso', price: 5.00, business:'Garage Grill'},
          {id:'GG007', name:'Chorizo', price: 7.50, business:'Garage Grill'},
          {id:'GG008', name:'Pulled Pork', price: 11.00, business:'Garage Grill'},
          {id:'GG009', name:'Cheeseburger', price: 8.75, business:'Garage Grill'},
          {id:'GG010', name:'Parrillada', price: 30.00, business:'Garage Grill'},
          {id:'GG011', name:'Papas Cajún', price: 4.50, business:'Garage Grill'}
        ];
        
        const productSelectEl = document.getElementById('product-select');
        const next1ButtonEl = document.getElementById('next-1');
        const businessInputEl = document.getElementById('business');
        const priceInputEl = document.getElementById('price');
        const datetimeInputEl = document.getElementById('datetime');
        const prev2ButtonEl = document.getElementById('prev-2');
        const next2ButtonEl = document.getElementById('next-2');
        const prev3ButtonEl = document.getElementById('prev-3');
        const photoButtonEl = document.getElementById('photo-btn');
        const summaryUlEl = document.getElementById('summary');
        const prev4ButtonEl = document.getElementById('prev-4');
        const sendButtonEl = document.getElementById('send-btn');
        const whatsappInputEl = document.getElementById('whatsapp');
        const restartButtonEl = document.getElementById('restart');
        const videoElDOM = document.getElementById('video'); // Renamed to avoid conflict
        const iniciarCobroButtonEl = document.getElementById('iniciar-cobro-btn');
        const shareButtonPuntoEl = document.getElementById('whatsapp-share-btn-punto');


        if(productSelectEl){
            productSelectEl.innerHTML = '<option value=\"\">Seleccione un producto...</option>';
            products.forEach(p => {
              const opt = document.createElement('option');
              opt.value = p.id; opt.text = p.name;
              opt.dataset.biz = p.business; opt.dataset.pr = p.price;
              productSelectEl.add(opt);
            });
            productSelectEl.onchange = () => {
                if(next1ButtonEl) next1ButtonEl.disabled = !productSelectEl.value;
            }
        }

        if (iniciarCobroButtonEl) {
            iniciarCobroButtonEl.onclick = () => modals[1].show();
        }

        if(next1ButtonEl){
            next1ButtonEl.onclick = () => {
              if (!productSelectEl.value) return; // Ensure a product is selected
              const selectedOption = productSelectEl.selectedOptions[0];
              order.product = selectedOption.text;
              order.business = selectedOption.dataset.biz;
              order.price = parseFloat(selectedOption.dataset.pr);
              
              if(businessInputEl) businessInputEl.value = order.business;
              if(priceInputEl) priceInputEl.value = order.price.toFixed(2);
              
              const now = new Date();
              const pad = n => n.toString().padStart(2,'0');
              order.datetime = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
              if(datetimeInputEl) datetimeInputEl.value = order.datetime;
              
              modals[1].hide(); modals[2].show();
            };
        }

        if(prev2ButtonEl) prev2ButtonEl.onclick = () => { modals[2].hide(); modals[1].show(); };
        if(next2ButtonEl) next2ButtonEl.onclick = () => { modals[2].hide(); modals[3].show(); };
        if(prev3ButtonEl) prev3ButtonEl.onclick = () => { modals[3].hide(); modals[2].show(); };

        document.querySelectorAll('.pay-btn').forEach(b => b.onclick = () => {
          order.pay = b.dataset.pay;
          if(photoButtonEl) photoButtonEl.style.display = (order.pay==='Yappy') ? 'block' : 'none';
          
          if(summaryUlEl) summaryUlEl.innerHTML = '';
          
          const titles = { product:'Producto', business:'Negocio', datetime:'Fecha y Hora', price:'Precio', pay:'Método de Pago' };
          const fmt = (k,v) => k==='price'?`$${parseFloat(v).toFixed(2)}`:k==='datetime'? v.replace(/-/g,'/'):v;
          
          ['product','business','datetime','price','pay'].forEach(k => {
            if (order[k] !== undefined) { // Check if key exists in order
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `${titles[k]}: ${fmt(k,order[k])}`;
                if(summaryUlEl) summaryUlEl.append(li);
            }
          });
          modals[3].hide(); modals[4].show();
        });

        if(prev4ButtonEl) prev4ButtonEl.onclick = () => { modals[4].hide(); modals[3].show(); };
        if(sendButtonEl){
            sendButtonEl.onclick = () => {
              if (whatsappInputEl && !whatsappInputEl.value.trim()) {
                alert('Por favor, ingrese un número de WhatsApp válido.');
                return;
              }
              modals[4].hide(); modals[5].show();
            };
        }

        if(restartButtonEl) restartButtonEl.onclick = () => location.reload();

        if(photoButtonEl){
            photoButtonEl.onclick = () => {
              if (navigator.mediaDevices?.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                  .then(stream => { 
                      if(videoElDOM) {
                          videoElDOM.srcObject = stream; 
                          videoElDOM.style.display='block'; 
                      }
                  })
                  .catch(() => alert('No se pudo acceder a la cámara.'));
              } else alert('API de cámara no compatible.');
            };
        }
        
        if (shareButtonPuntoEl) {
          shareButtonPuntoEl.addEventListener('click', function(event) {
            event.preventDefault();
            const webAppURL = encodeURIComponent(window.location.origin + '/frontend/index.html'); // Or your desired share URL
            const shareText = encodeURIComponent(`¡Echa un vistazo a esta aplicación Mealkitz: ${webAppURL}`);
            let whatsappLink = `https://wa.me/?text=${shareText}`;
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
              whatsappLink = `whatsapp://send?text=${shareText}`;
            }
            window.open(whatsappLink, '_blank');
          });
        }
      });
    </script>
  </body>
</html>
